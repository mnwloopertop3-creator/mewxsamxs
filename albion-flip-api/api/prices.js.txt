// api/prices.js (โค้ดสำหรับ Serverless Function บน Vercel)
const fetch = require('node-fetch');

// 1. กำหนด Item ID และ Locations ที่คุณต้องการ
const itemIds = [
    "T6_BAG", 
    "T7_BAG", 
    "T8_BAG" 
    // ... อื่นๆ ที่คุณเพิ่ม
];
const locations = [ // <--- ต้องใช้ [ ]
    "Black Market", 
    "Bridgewatch", 
    "Martlock", 
    "Fort Sterling", 
    "Thetford", 
    "Lymhurst", 
    "Caerleon"
];
const QUALITY = 1;
const FEE_RATE = 0.065;

module.exports = async (req, res) => {
    try {
        // 2. สร้าง URL API
        const apiUrl = `https://west.albion-online-data.com/api/v2/stats/prices/${itemIds.join(',')}` +
                       `?locations=${locations.join(',')}` +
                       `&qualities=${QUALITY}`;

        const response = await fetch(apiUrl);
        const data = await response.json();

        // 3. ประมวลผลและคำนวณกำไร (Logic เดิม)
        const bmData = data.filter(d => d.city === "Black Market");
        const bmMap = new Map();
        bmData.forEach(item => {
            const sellPriceGross = item.buy_price_max / (1 - FEE_RATE);
            bmMap.set(item.item_id, sellPriceGross);
        });

        const results = data
            .filter(d => d.city !== "Black Market" && d.sell_price_min > 0)
            .map(cityItem => {
                const itemId = cityItem.item_id;
                const buyPrice = cityItem.sell_price_min; 
                const sOrderPriceGross = bmMap.get(itemId) || 0; 

                if (sOrderPriceGross === 0 || sOrderPriceGross <= buyPrice) {
                    return null;
                }

                const revenueAfterFee = sOrderPriceGross * (1 - FEE_RATE);
                const finalProfit = revenueAfterFee - buyPrice; 

                return {
                    itemId: itemId,
                    city: cityItem.city,
                    buyPrice: buyPrice,
                    sellPriceGross: sOrderPriceGross.toFixed(0),
                    finalProfit: finalProfit.toFixed(0),
                    margin: ((finalProfit / buyPrice) * 100).toFixed(2) + '%'
                };
            })
            .filter(Boolean)
            .sort((a, b) => b.finalProfit - a.finalProfit);

        res.setHeader('Content-Type', 'application/json'); 
        res.status(200).send(JSON.stringify(results));
    } catch (error) {
        // ถ้าเกิด Error ในโค้ด จะแสดง 500 แทน 404 ซึ่งช่วยให้เรา Debug ได้
        res.status(500).send(JSON.stringify({ error: error.message, location: "API execution" }));
    }
};